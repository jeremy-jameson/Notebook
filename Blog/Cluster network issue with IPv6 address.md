# Cluster network issue with IPv6 address

Wednesday, January 11, 2017
5:24 AM

## Configure failover clustering (for SQL Server AlwaysOn Availability Group)

---


**FOOBAR8**

```PowerShell
cls
```

### # Add a second network adapter for cluster network

```PowerShell
$vmHost = "TT-HV01A"
$vmName = "TT-SQL01A"

Stop-VM -ComputerName $vmHost -Name $vmName

Add-VMNetworkAdapter -ComputerName $vmHost -VMName $vmName -SwitchName "Tenant vSwitch"

Start-VM -ComputerName $vmHost -Name $vmName
```

---


```PowerShell
cls
```

### # Configure cluster network settings

#### # Configure cluster network adapter

```PowerShell
$interfaceAlias = "Cluster"
```

##### # Configure cluster network adapter

```PowerShell
Get-NetAdapter `
    -InterfaceDescription "Microsoft Hyper-V Network Adapter #2" |
    Rename-NetAdapter -NewName $interfaceAlias
```

##### # Disable DHCP and router discovery

```PowerShell
@("IPv4", "IPv6") | ForEach-Object {
    $addressFamily = $_

    $interface = Get-NetAdapter $interfaceAlias |
        Get-NetIPInterface -AddressFamily $addressFamily

    If ($interface.Dhcp -eq "Enabled")
    {
        # Remove existing gateway
        $ipConfig = $interface | Get-NetIPConfiguration

        If ($addressFamily -eq "IPv4" -and $ipConfig.Ipv4DefaultGateway)
        {
            $interface |
                Remove-NetRoute -AddressFamily $addressFamily -Confirm:$false
        }
        ElseIf ($addressFamily -eq "IPv6" -and $ipConfig.Ipv6DefaultGateway)
        {
            $interface |
                Remove-NetRoute -AddressFamily $addressFamily -Confirm:$false
        }

        # Disable DHCP
        $interface | Set-NetIPInterface -DHCP Disabled
    }
}

Get-NetIPAddress -InterfaceAlias $interfaceAlias -AddressFamily IPv6 |
    Remove-NetIPAddress -Confirm:$false
```

##### # Configure static IPv4 address

```PowerShell
$ipAddress = "172.16.0.1"

New-NetIPAddress `
    -InterfaceAlias $interfaceAlias `
    -IPAddress $ipAddress `
    -PrefixLength 24
```

#### # Configure static IPv6 address

**# Note:** Private IPv6 address range (fd66:d7e2:39d6:a4d9::/64) generated by [http://simpledns.com/private-ipv6.aspx](http://simpledns.com/private-ipv6.aspx)

```PowerShell
$ipAddress = "fd66:d7e2:39d6:a4d9::1"

Get-NetIPAddress -InterfaceAlias $interfaceAlias -AddressFamily IPv6 |
    Remove-NetIPAddress -Confirm:$false

New-NetIPAddress `
    -InterfaceAlias $interfaceAlias `
    -IPAddress $ipAddress `
    -PrefixLength 64
```

```PowerShell
cls
```

### # Install Failover Clustering feature

```PowerShell
Install-WindowsFeature –Name Failover-Clustering –IncludeManagementTools
```

```PowerShell
cls
```

### # Run all cluster validation tests

```PowerShell
Test-Cluster -Node TT-SQL01A, TT-SQL01B
```

> **Note**
> 
> Wait for the cluster validation tests to complete.

```PowerShell
& "C:\Users\jjameson-admin\AppData\Local\Temp\Validation Report 2017.01.10 At 18.17.09.htm"
```

> **Note**
> 
> The cluster validation report contains the following warnings:
> 
> - **Network interface TT-SQL01A.corp.technologytoolbox.com - Datacenter 1 does not have an address with subnet prefix 172.16.0.0 / 24.**
> - **Network interface TT-SQL01A.corp.technologytoolbox.com - Datacenter 1 does not have an address with subnet prefix fd66:d7e2:39d6:a4d9:: / 64.**
> - **Network interface TT-SQL01A.corp.technologytoolbox.com - Cluster does not have an address with subnet prefix 192.168.10.0 / 24.**
> - **Network interface TT-SQL01B.corp.technologytoolbox.com - Cluster does not have an address with subnet prefix 192.168.10.0 / 24.**
> - **Network interface TT-SQL01B.corp.technologytoolbox.com - Datacenter 1 does not have an address with subnet prefix 172.16.0.0 / 24.**
> - **Network interface TT-SQL01B.corp.technologytoolbox.com - Datacenter 1 does not have an address with subnet prefix fd66:d7e2:39d6:a4d9:: / 64.**
> - **DHCP status for network interface TT-SQL01A.corp.technologytoolbox.com - Cluster differs from network Cluster Network 1.**
> - **DHCP status for network interface TT-SQL01B.corp.technologytoolbox.com - Cluster differs from network Cluster Network 1.**
> 
> Since I could not find a way to remove the automatically assigned IPv6 addresses (e.g. **2603:300b:802:8900:b0f0:22ba:d3a6:1ab6**), the only way I could resolve the cluster validation warnings is to change the secondary network adapters to use DHCP.

> **Important**
> 
> Change "Cluster" network adapters on TT-SQL01A and TT-SQL01B to use DHCP (for both IPv4 and IPv6) and then run the cluster validation tests again.

```PowerShell
Test-Cluster -Node TT-SQL01A, TT-SQL01B
```
